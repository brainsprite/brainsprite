# CLAUDE.md

## Project Overview

Brainsprite is a library for interactive 3D brain viewers in HTML web documents. It has two components:
- **JavaScript rendering engine** (`src/brainsprite.js`): lightweight canvas-based 3D brain viewer
- **Python API** (`src/brainsprite/`): prepares neuroimaging data and populates HTML templates

## Build & Test Commands

### Python
```bash
pip install tox
tox run -e test -- tests/python    # Python unit tests
tox run -e examples                 # Run example scripts (generates HTML fixtures for JS tests)
tox run -e doc                      # Build Sphinx documentation
tox run -e lint                     # Run linting (default env)
```

### JavaScript
```bash
npm install                         # Install JS dependencies
make coverage                       # Full JS coverage (runs tox examples + jest)
npx jest                            # Run JS tests only
```

### Build
```bash
make minify                         # Minify JS with esbuild
make build                          # Full build: clean + minify + Python wheel
```

### Code Style
```bash
pre-commit install                  # Install git hooks
pre-commit run -a                   # Run all style checks locally
```

## Code Style

**Python** (enforced via Ruff):
- Line length: 100 characters
- Double quotes, 4-space indent
- Docstrings required for all public classes/functions
- Run `ruff format` and `ruff check` before committing

**JavaScript** (StandardJS/semistandard):
- No semicolons, 2-space indent, single quotes
- Checked by pre-commit hook

**Commit message format**: `[TAG] description`
- Tags: `[FIX]`, `[ENH]`, `[MAINT]`, `[REL]`, `[STY]`
- Examples: `[FIX] update private import nilearn`, `[MAINT] drop python 3.9`

## Project Structure

```
src/
  brainsprite.js              # Main JS library (673 lines, canvas-based)
  brainsprite/
    __init__.py               # Public API exports
    brainsprite.py            # Core Python module
    data/
      html/                   # HTML templates (Tempita syntax)
      js/                     # Minified JS and template JS
tests/
  python/test_brainsprite.py  # Python unit tests
  js/                         # Jest + Puppeteer visual regression tests
examples/                     # Annotated example scripts (plot_anat.py, plot_stat_map.py)
docs/source/                  # Sphinx documentation
```

## Architecture

**Python pipeline**: Load NIfTI neuroimaging data → resample/normalize → apply thresholds → convert 3D volume to 2D sprite sheet → encode as base64 → generate HTML/JS snippet via Tempita templates.

**JavaScript pipeline**: Initialize viewer with sprite + params → handle mouse/keyboard interaction → draw orthogonal slices (sagittal, coronal, axial) → render colormaps and overlays.

**Key Python entry points**:
- `viewer_substitute` class — prepares viewer data and generates HTML/JS
- `StatMapView` — extends HTMLDocument for statistical map viewing

**HTML templates** use `{{ }}` Tempita syntax. Two modes: base64-embedded images or external file references.

## Key Dependencies

- **Python runtime**: `nilearn[plotting]>=0.12.0`, `tempita`
- **Python dev**: `tox`, `ruff`, `pre-commit`, `pytest`, `pytest-cov`
- **JS runtime**: jQuery 3.5.0+ (optional, used in examples only)
- **JS build**: `esbuild` (minification)
- **JS test**: `jest`, `puppeteer` (visual regression), `pixelmatch`, `nyc` (coverage)

## Testing Notes

- JS tests use **visual regression** (Puppeteer renders pages, pixelmatch compares screenshots to reference images)
- Reference HTML fixtures for JS tests are generated by `tox run -e examples` — run this before JS tests
- Python tests support doctests (enabled in pytest config)
- CI tests against Python 3.10–3.14 on Ubuntu, macOS, Windows
