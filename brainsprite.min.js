function displayFloat(t,e){var a=parseFloat(t).toFixed(e);return-1===a.indexOf(".")?a+".":a.replace(/0+$/,"")}function initBrain(t){var e=Object.assign({},{smooth:!1,flagValue:!1,colorBackground:"#000000",flagCoordinates:!1,origin:{X:0,Y:0,Z:0},voxelSize:1,affine:!1,heightColorBar:.04,sizeFont:.075,colorFont:"#FFFFFF",nbDecimals:3,crosshair:!1,colorCrosshair:"#0000FF",sizeCrosshair:.9,title:!1,numSlice:!1,onclick:"",radiological:!1,showLR:!0},t);return"boolean"==typeof e.affine&&!1===e.affine&&(e.affine=[[e.voxelSize,0,0,-e.origin.X],[0,e.voxelSize,0,-e.origin.Y],[0,0,e.voxelSize,-e.origin.Z],[0,0,0,1]]),e.flagCoordinates?e.spaceFont=.1:e.spaceFont=0,e.coordinatesSlice={X:0,Y:0,Z:0},e.widthCanvas={X:0,Y:0,Z:0,max:0},e.heightCanvas={X:0,Y:0,Z:0,max:0},e}function initCanvas(t,e){return t.canvas=document.getElementById(e),t.context=t.canvas.getContext("2d"),t.context.imageSmoothingEnabled=t.smooth,t.canvasY=document.createElement("canvas"),t.contextY=t.canvasY.getContext("2d"),t.canvasZ=document.createElement("canvas"),t.contextZ=t.canvasZ.getContext("2d"),t.canvasRead=document.createElement("canvas"),t.contextRead=t.canvasRead.getContext("2d"),t.canvasRead.width=1,t.canvasRead.height=1,t.planes={},t.planes.canvasMaster=document.createElement("canvas"),t.planes.contextMaster=t.planes.canvasMaster.getContext("2d"),t}function initSprite(t,e,a){return t.sprite=document.getElementById(e),t.nbCol=t.sprite.width/a.Y,t.nbRow=t.sprite.height/a.Z,t.nbSlice={X:void 0!==a.X?a.X:t.nbCol*t.nbRow,Y:a.Y,Z:a.Z},!1===t.numSlice&&(t.numSlice={X:Math.floor(t.nbSlice.X/2),Y:Math.floor(t.nbSlice.Y/2),Z:Math.floor(t.nbSlice.Z/2)}),t}function initOverlay(t,e,a){return t.overlay.opacity=void 0!==t.overlay.opacity?t.overlay.opacity:1,t.overlay.sprite=document.getElementById(e),t.overlay.nbCol=t.overlay.sprite.width/a.Y,t.overlay.nbRow=t.overlay.sprite.height/a.Z,t.overlay.nbSlice={X:void 0!==a.X?a.X:t.overlay.nbCol*t.overlay.nbRow,Y:a.Y,Z:a.Z},t}function initColorMap(t){return t.hide=void 0!==t.hide&&t.hide,t.img=document.getElementById(t.img),t.canvas=document.createElement("canvas"),t.context=t.canvas.getContext("2d"),t.canvas.width=t.img.width,t.canvas.height=t.img.height,t.context.drawImage(t.img,0,0,t.img.width,t.img.height,0,0,t.img.width,t.img.height),t}function brainsprite(t){let e=initBrain(t);e=initCanvas(e,t.canvas),e=initSprite(e,t.sprite,t.nbSlice),t.overlay&&(e=initOverlay(e,t.overlay.sprite,t.overlay.nbSlice)),t.colorMap&&(e.colorMap=initColorMap(t.colorMap));let a=function(){const t={};if(e.overlay&&!e.nanValue)try{t.XW=Math.round(e.numSlice.X%e.nbCol),t.XH=Math.round((e.numSlice.X-t.XW)/e.nbCol),e.contextRead.clearRect(0,0,1,1),e.contextRead.drawImage(e.overlay.sprite,t.XW*e.nbSlice.Y+e.numSlice.Y,t.XH*e.nbSlice.Z+e.nbSlice.Z-e.numSlice.Z-1,1,1,0,0,1,1);const a=e.contextRead.getImageData(0,0,1,1).data;0===a[3]?e.voxelValue=NaN:e.voxelValue=function(t,e){if(!e)return NaN;let a=NaN,n=1/0;const i=e.canvas.width,l=e.context.getImageData(0,0,i,1).data;for(let e=0;e<i;e++){const i=Math.abs(l[4*e]-t[0])+Math.abs(l[4*e+1]-t[1])+Math.abs(l[4*e+2]-t[2]);i<n&&(a=e,n=i)}return a*(e.max-e.min)/(i-1)+e.min}(a,e.colorMap)}catch(t){console.warn(t.message),e.nanValue=!0,e.voxelValue=NaN}else e.voxelValue=NaN};const n=[0,0,0];let i=function(){!function(t,e,a){for(let n=0;n<3;++n)t[n]=a[0]*e[n][0]+a[1]*e[n][1]+a[2]*e[n][2]+a[3]*e[n][3]}(n,e.affine,[e.numSlice.X+1,e.numSlice.Y+1,e.numSlice.Z+1,1]),e.coordinatesSlice.X=n[0],e.coordinatesSlice.Y=n[1],e.coordinatesSlice.Z=n[2]};return e.init=function(){let t=e.nbSlice.X,n=e.nbSlice.Y,l=e.nbSlice.Z;e.resize(),e.planes.canvasMaster.width=e.sprite.width,e.planes.canvasMaster.height=e.sprite.height,e.planes.contextMaster.globalAlpha=1,e.planes.contextMaster.drawImage(e.sprite,0,0,e.sprite.width,e.sprite.height,0,0,e.sprite.width,e.sprite.height),e.overlay&&(e.planes.contextMaster.globalAlpha=e.overlay.opacity,e.planes.contextMaster.drawImage(e.overlay.sprite,0,0,e.overlay.sprite.width,e.overlay.sprite.height,0,0,e.sprite.width,e.sprite.height)),e.planes.canvasX=document.createElement("canvas"),e.planes.contextX=e.planes.canvasX.getContext("2d"),e.planes.canvasX.width=n,e.planes.canvasX.height=l,e.planes.canvasY=document.createElement("canvas"),e.planes.contextY=e.planes.canvasY.getContext("2d"),e.planes.canvasY.width=t,e.planes.canvasY.height=l,e.planes.canvasZ=document.createElement("canvas"),e.planes.contextZ=e.planes.canvasZ.getContext("2d"),e.planes.canvasZ.width=t,e.planes.canvasZ.height=n,e.planes.contextZ.rotate(-Math.PI/2),e.planes.contextZ.translate(-n,0),a(),i(),e.numSlice.X=Math.round(e.numSlice.X),e.numSlice.Y=Math.round(e.numSlice.Y),e.numSlice.Z=Math.round(e.numSlice.Z)},e.resize=function(){let t=e.canvas.parentElement.clientWidth,a=e.nbSlice.X,n=e.nbSlice.Y,i=e.nbSlice.Z;const l=Math.floor(t*(n/(2*a+n))),o=Math.floor(t*(a/(2*a+n))),c=Math.floor(t*(a/(2*a+n)));if(l===e.widthCanvas.X&&o===e.widthCanvas.Y&&c===e.widthCanvas.Z)return!1;e.widthCanvas.X=l,e.widthCanvas.Y=o,e.widthCanvas.Z=c,e.widthCanvas.max=Math.max(l,o,c),e.heightCanvas.X=Math.floor(e.widthCanvas.X*i/n),e.heightCanvas.Y=Math.floor(e.widthCanvas.Y*i/a),e.heightCanvas.Z=Math.floor(e.widthCanvas.Z*n/a),e.heightCanvas.max=Math.max(e.heightCanvas.X,e.heightCanvas.Y,e.heightCanvas.Z);let s=e.widthCanvas.X+e.widthCanvas.Y+e.widthCanvas.Z;return e.canvas.width!==s&&(e.canvas.width=s,e.canvas.height=Math.round((1+e.spaceFont)*e.heightCanvas.max),e.context.imageSmoothingEnabled=e.smooth),e.sizeFontPixels=Math.round(e.sizeFont*e.heightCanvas.max),e.context.font=e.sizeFontPixels+"px Arial",!0},e.draw=function(t,a){let n,i,l,o={},c=Math.ceil((1-e.sizeCrosshair)*e.nbSlice.X/2),s=Math.ceil((1-e.sizeCrosshair)*e.nbSlice.Y/2),h=Math.ceil((1-e.sizeCrosshair)*e.nbSlice.Z/2),r=e.nbSlice.Y,d=e.nbSlice.Z;switch(a){case"X":if(o.XW=e.numSlice.X%e.nbCol,o.XH=(e.numSlice.X-o.XW)/e.nbCol,e.planes.contextX.drawImage(e.planes.canvasMaster,o.XW*r,o.XH*d,r,d,0,0,r,d),e.crosshair&&(e.planes.contextX.fillStyle=e.colorCrosshair,e.planes.contextX.fillRect(e.numSlice.Y,h,1,d-2*h),e.planes.contextX.fillRect(s,d-e.numSlice.Z-1,r-2*s,1)),e.context.fillStyle=e.colorBackground,e.context.fillRect(0,0,e.widthCanvas.X,e.canvas.height),e.context.drawImage(e.planes.canvasX,0,0,r,d,0,(e.heightCanvas.max-e.heightCanvas.X)/2,e.widthCanvas.X,e.heightCanvas.X),e.title&&(e.context.fillStyle=e.colorFont,e.context.fillText(e.title,Math.round(e.widthCanvas.X/10),Math.round(e.heightCanvas.max*e.heightColorBar+e.sizeFontPixels/4))),e.flagValue){const t=isNaN(e.voxelValue)?"no value":"value = "+displayFloat(e.voxelValue,e.nbDecimals);e.context.fillStyle=e.colorFont,e.context.fillText(t,Math.round(e.widthCanvas.X/10),Math.round(e.heightCanvas.max*e.heightColorBar*2+3/4*e.sizeFontPixels))}e.flagCoordinates&&(n="x = "+Math.round(e.coordinatesSlice.X),i=e.context.measureText(n).width,e.context.fillStyle=e.colorFont,e.context.fillText(n,e.widthCanvas.X/2-i/2,Math.round(e.canvas.height-e.sizeFontPixels/2)));break;case"Y":for(e.context.fillStyle=e.colorBackground,e.context.fillRect(e.widthCanvas.X,0,e.widthCanvas.Y,e.canvas.height),l=0;l<e.nbSlice.X;l++){let t=l%e.nbCol,a=(l-t)/e.nbCol;e.planes.contextY.drawImage(e.planes.canvasMaster,t*e.nbSlice.Y+e.numSlice.Y,a*e.nbSlice.Z,1,e.nbSlice.Z,l,0,1,e.nbSlice.Z)}if(e.crosshair&&(e.planes.contextY.fillStyle=e.colorCrosshair,e.planes.contextY.fillRect(e.numSlice.X,h,1,e.nbSlice.Z-2*h),e.planes.contextY.fillRect(c,e.nbSlice.Z-e.numSlice.Z-1,e.nbSlice.X-2*c,1)),e.context.drawImage(e.planes.canvasY,0,0,e.nbSlice.X,e.nbSlice.Z,e.widthCanvas.X,(e.heightCanvas.max-e.heightCanvas.Y)/2,e.widthCanvas.Y,e.heightCanvas.Y),e.colorMap&&!e.colorMap.hide){e.context.drawImage(e.colorMap.img,0,0,e.colorMap.img.width,1,Math.round(e.widthCanvas.X+.2*e.widthCanvas.Y),Math.round(e.heightCanvas.max*e.heightColorBar/2),Math.round(.6*e.widthCanvas.Y),Math.round(e.heightCanvas.max*e.heightColorBar)),e.context.fillStyle=e.colorFont;const t=displayFloat(e.colorMap.min,e.nbDecimals),a=displayFloat(e.colorMap.max,e.nbDecimals);e.context.fillText(t,e.widthCanvas.X+.2*e.widthCanvas.Y-e.context.measureText(t).width/2,Math.round(e.heightCanvas.max*e.heightColorBar*2+3/4*e.sizeFontPixels)),e.context.fillText(a,e.widthCanvas.X+.8*e.widthCanvas.Y-e.context.measureText(a).width/2,Math.round(e.heightCanvas.max*e.heightColorBar*2+3/4*e.sizeFontPixels))}if(e.flagCoordinates&&(e.context.font=e.sizeFontPixels+"px Arial",e.context.fillStyle=e.colorFont,n="y = "+Math.round(e.coordinatesSlice.Y),i=e.context.measureText(n).width,e.context.fillText(n,e.widthCanvas.X+e.widthCanvas.Y/2-i/2,Math.round(e.canvas.height-e.sizeFontPixels/2))),e.showLR){const t=!!e.radiological,a=Math.round(e.canvas.height/2),{font:n,textAlign:i,textBaseline:l}=e.context;e.context.font=`${e.sizeFontPixels}px Arial`,e.context.textAlign="center",e.context.textBaseline="middle",e.context.fillStyle=e.colorFont;const o=t?"R":"L",c=t?"L":"R",s=.05,h=e.widthCanvas.Y*s;e.context.fillText(o,e.widthCanvas.X+h,a),e.context.fillText(c,e.widthCanvas.X+e.widthCanvas.Y-h,a),e.context.font=n,e.context.textAlign=i,e.context.textBaseline=l}break;case"Z":for(e.context.fillStyle=e.colorBackground,e.context.fillRect(e.widthCanvas.X+e.widthCanvas.Y,0,e.widthCanvas.Z,e.canvas.height),l=0;l<e.nbSlice.X;l++){let t=l%e.nbCol,a=(l-t)/e.nbCol;e.planes.contextZ.drawImage(e.planes.canvasMaster,t*e.nbSlice.Y,a*e.nbSlice.Z+e.nbSlice.Z-e.numSlice.Z-1,e.nbSlice.Y,1,0,l,e.nbSlice.Y,1)}if(e.crosshair&&(e.planes.contextZ.fillStyle=e.colorCrosshair,e.planes.contextZ.fillRect(s,e.numSlice.X,e.nbSlice.Y-2*s,1),e.planes.contextZ.fillRect(e.numSlice.Y,c,1,e.nbSlice.X-2*c)),e.context.drawImage(e.planes.canvasZ,0,0,e.nbSlice.X,e.nbSlice.Y,e.widthCanvas.X+e.widthCanvas.Y,(e.heightCanvas.max-e.heightCanvas.Z)/2,e.widthCanvas.Z,e.heightCanvas.Z),e.flagCoordinates&&(n="z = "+Math.round(e.coordinatesSlice.Z),i=e.context.measureText(n).width,e.context.fillStyle=e.colorFont,e.context.fillText(n,e.widthCanvas.X+e.widthCanvas.Y+e.widthCanvas.Z/2-i/2,Math.round(e.canvas.height-e.sizeFontPixels/2))),e.showLR){const t=!!e.radiological,a=Math.round(e.canvas.height/2),{font:n,textAlign:i,textBaseline:l}=e.context;e.context.font=`${e.sizeFontPixels}px Arial`,e.context.textAlign="center",e.context.textBaseline="middle",e.context.fillStyle=e.colorFont;const o=t?"R":"L",c=t?"L":"R",s=.05,h=e.widthCanvas.Y*s;e.context.fillText(o,e.widthCanvas.X+e.widthCanvas.Y+h,a),e.context.fillText(c,e.widthCanvas.X+e.widthCanvas.Y+e.widthCanvas.Z-h,a),e.context.font=n,e.context.textAlign=i,e.context.textBaseline=l}}},e.clickBrain=function(t){let n,l,o=e.canvas.getBoundingClientRect(),c=t.clientX-o.left,s=t.clientY-o.top;if(c<e.widthCanvas.X)n=Math.round((e.nbSlice.Y-1)*(c/e.widthCanvas.X)),l=Math.round((e.nbSlice.Z-1)*((e.heightCanvas.max+e.heightCanvas.X)/2-s)/e.heightCanvas.X),e.numSlice.Y=Math.max(Math.min(n,e.nbSlice.Y-1),0),e.numSlice.Z=Math.max(Math.min(l,e.nbSlice.Z-1),0);else if(c<e.widthCanvas.X+e.widthCanvas.Y){c-=e.widthCanvas.X;let t=Math.round((e.nbSlice.X-1)*(c/e.widthCanvas.Y)),a=Math.round((e.nbSlice.Z-1)*((e.heightCanvas.max+e.heightCanvas.X)/2-s)/e.heightCanvas.X);e.numSlice.X=Math.max(Math.min(t,e.nbSlice.X-1),0),e.numSlice.Z=Math.max(Math.min(a,e.nbSlice.Z-1),0)}else{c=c-e.widthCanvas.X-e.widthCanvas.Y;let t=Math.round((e.nbSlice.X-1)*(c/e.widthCanvas.Z)),a=Math.round((e.nbSlice.Y-1)*((e.heightCanvas.max+e.heightCanvas.Z)/2-s)/e.heightCanvas.Z);e.numSlice.X=Math.max(Math.min(t,e.nbSlice.X-1),0),e.numSlice.Y=Math.max(Math.min(a,e.nbSlice.Y-1),0)}a(),i(),e.drawAll(),e.onclick&&e.onclick(t)},e.drawAll=function(){e.draw(e.numSlice.X,"X"),e.draw(e.numSlice.Y,"Y"),e.draw(e.numSlice.Z,"Z")},e.canvas.addEventListener("click",e.clickBrain,!1),e.canvas.addEventListener("mousedown",(function(){e.canvas.addEventListener("mousemove",e.clickBrain,!1)}),!1),e.canvas.addEventListener("mouseup",(function(){e.canvas.removeEventListener("mousemove",e.clickBrain,!1)}),!1),e.sprite.addEventListener("load",(function(){e.init(),e.drawAll()})),e.overlay&&e.overlay.sprite.addEventListener("load",(function(){e.init(),e.drawAll()})),e.init(),e.drawAll(),window.addEventListener("resize",(function(){e.resize()&&e.drawAll()})),e}
